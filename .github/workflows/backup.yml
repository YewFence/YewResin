name: Docker Backup

on:
  # 每天凌晨 3 点执行 (UTC 时间，记得转换成你的时区)
  schedule:
    - cron: '0 19 * * *'  # UTC 19:00 = 北京时间 03:00

  # 支持手动触发
  workflow_dispatch:
    inputs:
      dry_run:
        description: '模拟运行（不实际执行）'
        required: false
        default: false
        type: boolean
      ignore_backup_error:
        description: '即使备份失败也继续执行'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 配置 SSH 连接
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${SSH_PORT:-22} $SSH_HOST >> ~/.ssh/known_hosts

      - name: 执行备份脚本
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          IGNORE_BACKUP_ERROR: ${{ github.event.inputs.ignore_backup_error || 'true' }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          if [ "$DRY_RUN" = "true" ]; then
            BACKUP_ARGS="--dry-run"
          else
            BACKUP_ARGS="-y"
          fi
          ssh -p ${SSH_PORT:-22} ${SSH_USER}@${SSH_HOST} "IGNORE_BACKUP_ERROR=${IGNORE_BACKUP_ERROR} bash -s -- ${BACKUP_ARGS}" < YewResin/backup.sh

      - name: 清理 SSH 密钥
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
